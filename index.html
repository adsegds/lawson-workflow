<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>業務チェックリスト（スタッフ用）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #fffaf2;
      color: #111;
      line-height: 1.6;
      font-size: 14px;
    }

    .app-shell {
      max-width: 1080px;
      margin: 0 auto;
      padding: 12px 10px 32px;
    }

    header.app-header {
      background: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .app-title {
      font-size: 18px;
      font-weight: 700;
    }
    .app-sub {
      font-size: 11px;
      color: #666;
    }

    .header-left {
      flex: 1 1 220px;
    }
    .header-right {
      flex: 1 1 220px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
    }

    label {
      font-size: 11px;
      font-weight: 600;
      margin-bottom: 2px;
      display: block;
    }
    input[type="text"] {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      padding: 4px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }
    input[type="text"]:focus {
      border-color: #111;
    }

    .device-field {
      min-width: 200px;
      max-width: 260px;
    }
    .hint {
      font-size: 10px;
      color: #777;
      margin-top: 2px;
    }

    button {
      font-family: inherit;
      font-size: 12px;
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      cursor: pointer;
    }
    .btn-primary {
      background: #111;
      color: #fff;
    }
    .btn-secondary {
      background: #eee;
      color: #333;
    }

    main {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 12px 12px 14px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
    }
    .card-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .card-sub {
      font-size: 11px;
      color: #777;
      margin-bottom: 8px;
    }

    /* ===== お知らせ ===== */
    .news-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      max-height: 150px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
    }
    .news-item {
      font-size: 12px;
      padding: 4px 6px;
      border-radius: 8px;
      background: #fff8e5;
      border: 1px solid #f3dd9c;
    }
    .news-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .news-meta {
      font-size: 10px;
      color: #a67c00;
      margin-top: 2px;
    }

    /* ===== 引き継ぎメモ ===== */
    .handover-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }
    .handover-chip {
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #ddd;
      background: #f8f8f8;
      cursor: pointer;
    }
    .handover-chip:hover {
      background: #111;
      color: #fff;
      border-color: #111;
    }

    /* ===== 時間帯セクション ===== */
    .slot-section {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .slot {
      background: #fff;
      border-radius: 12px;
      padding: 8px 10px 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      border-left: 4px solid #f1c27d;
    }
    .slot-header {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      margin-bottom: 4px;
    }
    .slot-title {
      font-size: 14px;
      font-weight: 700;
    }
    .slot-label {
      font-size: 11px;
      color: #777;
    }

    .slot-body {
      margin-top: 2px;
      display: grid;
      grid-template-columns: minmax(0,1fr);
      gap: 6px;
    }
    @media (min-width: 720px) {
      .slot-body {
        grid-template-columns: minmax(0,1.1fr) minmax(0,1fr);
      }
    }

    .task-group-title {
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .task-group-title span.badge {
      font-size: 10px;
      display: inline-block;
      padding: 1px 6px;
      border-radius: 999px;
      margin-right: 4px;
    }
    .badge-a {
      background: #f97316;
      color: #fff;
    }
    .badge-b {
      background: #4b5563;
      color: #fff;
    }

    ul.task-list {
      list-style: none;
      border-radius: 8px;
      border: 1px solid #eee;
      padding: 4px 6px;
      max-height: 220px;
      overflow-y: auto;
    }
    .task-item {
      display: flex;
      align-items: flex-start;
      gap: 6px;
      padding: 2px 0;
      font-size: 12px;
    }
    .task-item input[type="checkbox"] {
      margin-top: 2px;
    }

    .status {
      font-size: 11px;
      margin-top: 2px;
      min-height: 16px;
    }
    .status.ok { color: #007700; }
    .status.err { color: #cc0000; }

    .slots-status {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
    }

    /* シフト表ボタンなど */
    .top-btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      justify-content: flex-end;
    }

    @media (max-width: 600px) {
      header.app-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .header-right {
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="header-left">
        <div class="app-title">業務チェックリスト</div>
        <div class="app-sub">※時間帯の枠は owner 画面の「時間帯設定」と連動しています。</div>
      </div>
      <div class="header-right">
        <div class="device-field">
          <label for="deviceLabelInput">この端末のラベル</label>
          <input id="deviceLabelInput" type="text" placeholder="例：レジ横iPad / 事務所PC" />
          <div class="hint">ログやグラフでどの端末か分かるように名前を付けてください。</div>
        </div>
        <div class="top-btn-row">
          <button type="button" class="btn-secondary" id="openNoticeCenterBtn">
            お知らせセンターを見る
          </button>
          <button type="button" class="btn-secondary" id="openShiftBtn">
            シフト表を開く
          </button>
        </div>
      </div>
    </header>

    <main>
      <!-- お知らせ -->
      <section class="card">
        <div class="card-title">お知らせ</div>
        <div class="card-sub">
          owner 画面「お知らせ管理」に登録された内容が、上から新しい順に最大20件表示されます。
        </div>
        <ul class="news-list" id="newsList">
          <li class="news-item">読み込み中...</li>
        </ul>
      </section>

      <!-- 引き継ぎメモ -->
      <section class="card">
        <div class="card-title">引き継ぎメモ（全員で共有）</div>
        <div class="card-sub">
          「やったこと・気づき」を一言メモで残すためのボタンセットです。<br>
          ボタンをタップすると、ログに「引き継ぎメモ」として記録されます。
        </div>
        <div class="handover-chips" id="handoverChips"></div>
        <div class="status" id="handoverStatus"></div>
      </section>

      <!-- 時間帯ごとのチェックリスト -->
      <section class="card">
        <div class="card-title">時間帯ごとのチェックリスト</div>
        <div class="card-sub">
          時間帯の枠は owner 画面の「時間帯ごとのタスク編集」で設定した
          <code>timeSlotsConfig.slots</code> と自動連動します。<br>
          新しい時間帯を追加したら、この画面を再読み込みすると反映されます。
        </div>
        <div class="slot-section" id="slotsContainer"></div>
        <div class="slots-status" id="slotsStatus"></div>
      </section>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // =============================
    // Firebase 設定
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
      authDomain: "lawson-workflow.firebaseapp.com",
      projectId: "lawson-workflow",
      storageBucket: "lawson-workflow.firebasestorage.app",
      messagingSenderId: "335371795694",
      appId: "1:335371795694:web:3b0950a616d368b284c7ff",
      measurementId: "G-BGENZNZMRC"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ★ 店舗ID（必要なら書き換えOK）
    const STORE_ID = "nambucho";

    const storeRef = db.collection("stores").doc(STORE_ID);
    const ownerNewsColRef = storeRef.collection("ownerNews");
    const handoverTplRef = storeRef.collection("handoverTemplates").doc("global");
    const logsColRef = storeRef.collection("checklistLogs");
    const taskSlotsRef = storeRef.collection("taskSlots");
    const tasksDocRef  = storeRef.collection("tasks").doc("main");
    const timeSlotsConfigRef = storeRef.collection("settings").doc("timeSlotsConfig"); // owner.html と合わせる
    const shiftDocRef = storeRef.collection("settings").doc("shiftSheet");

    // 6:00切り替えの「今日の営業日」
    function getCurrentBusinessKey() {
      const now = new Date();
      const y = now.getFullYear();
      const m = now.getMonth();
      const d = now.getDate();
      const base = new Date(y, m, d);
      if (now.getHours() < 7) {
        base.setDate(base.getDate() - 1);
      }
      const yy = base.getFullYear();
      const mm = String(base.getMonth() + 1).padStart(2, "0");
      const dd = String(base.getDate()).padStart(2, "0");
      return `${yy}-${mm}-${dd}`;
    }

    function getDefaultSlots() {
      return [
        { id: "t6-8",   label: "6:00〜8:00 朝の立ち上げ" },
        { id: "t9-11",  label: "9:00〜11:00 午前帯" },
        { id: "t12-14", label: "12:00〜14:00 昼帯" },
        { id: "t15-17", label: "15:00〜17:00 夕方前" },
        { id: "t18-20", label: "18:00〜20:00 夕方〜夜" },
        { id: "t21-23", label: "21:00〜23:00 夜帯" },
        { id: "t0-2",   label: "0:00〜2:00 深夜前半" },
        { id: "t3-5",   label: "3:00〜5:00 早朝" }
      ];
    }

    document.addEventListener("DOMContentLoaded", () => {
      initApp().catch((e) => {
        console.error(e);
        const slotsStatus = document.getElementById("slotsStatus");
        if (slotsStatus) {
          slotsStatus.textContent = "ページ初期化でエラーが発生しました：" + (e.message || "");
        }
      });
    });

    async function initApp() {
      const deviceInput = document.getElementById("deviceLabelInput");
      const DEVICE_KEY = "lw_deviceLabel";
      let currentDeviceLabel = "";

      if (deviceInput) {
        const saved = localStorage.getItem(DEVICE_KEY);
        if (saved) {
          deviceInput.value = saved;
          currentDeviceLabel = saved;
        }
        deviceInput.addEventListener("change", () => {
          currentDeviceLabel = deviceInput.value.trim();
          localStorage.setItem(DEVICE_KEY, currentDeviceLabel);
        });
      }

      // ① お知らせ
      initNewsSection();

      // ② 引き継ぎメモ
      initHandoverSection(currentDeviceLabel);

      // ③ シフト表ボタン
      initShiftButton();

      // ④ 時間帯ごとのチェックリスト
      await initTimeSlots(currentDeviceLabel);
    }

    // =============================
    // お知らせ表示
    // =============================
    function initNewsSection() {
      const newsList = document.getElementById("newsList");
      if (!newsList) return;

      ownerNewsColRef
        .orderBy("createdAt", "desc")
        .limit(20)
        .onSnapshot(
          (snapshot) => {
            newsList.innerHTML = "";
            if (snapshot.empty) {
              const li = document.createElement("li");
              li.className = "news-item";
              li.textContent = "現在、お知らせはありません。";
              newsList.appendChild(li);
              return;
            }
            snapshot.forEach((doc) => {
              const data = doc.data() || {};
              const li = document.createElement("li");
              li.className = "news-item";

              const titleEl = document.createElement("div");
              titleEl.className = "news-title";
              titleEl.textContent = data.title || "(タイトルなし)";

              const bodyEl = document.createElement("div");
              bodyEl.textContent = data.body || "";

              const metaEl = document.createElement("div");
              metaEl.className = "news-meta";
              const createdAt = data.createdAt ? data.createdAt.toDate() : null;
              metaEl.textContent = createdAt
                ? createdAt.toLocaleString("ja-JP")
                : "日時情報なし";

              li.appendChild(titleEl);
              li.appendChild(bodyEl);
              li.appendChild(metaEl);
              newsList.appendChild(li);
            });
          },
          (error) => {
            console.error("ownerNews 読み込みエラー", error);
            newsList.innerHTML = "";
            const li = document.createElement("li");
            li.className = "news-item";
            li.textContent = "お知らせの読み込みに失敗しました。";
            newsList.appendChild(li);
          }
        );

      // お知らせセンターへ
      const btn = document.getElementById("openNoticeCenterBtn");
      if (btn) {
        btn.addEventListener("click", () => {
          window.open("notice.html", "_blank");
        });
      }
    }

    // =============================
    // 引き継ぎメモボタン
    // =============================
    function initHandoverSection(initialDeviceLabel) {
      const chipsWrap = document.getElementById("handoverChips");
      const statusEl = document.getElementById("handoverStatus");
      const deviceInput = document.getElementById("deviceLabelInput");

      if (!chipsWrap || !statusEl) return;

      function getDeviceLabel() {
        const v = deviceInput ? deviceInput.value.trim() : "";
        return v || "未設定";
      }

      function setStatus(msg, ok) {
        statusEl.textContent = msg || "";
        statusEl.className = "status " + (ok ? "ok" : "err");
      }

      handoverTplRef.get().then((snap) => {
        chipsWrap.innerHTML = "";
        if (!snap.exists || !Array.isArray(snap.data().chips) || snap.data().chips.length === 0) {
          const span = document.createElement("span");
          span.textContent = "ボタンはまだ設定されていません。（owner画面で設定してください）";
          span.style.fontSize = "11px";
          span.style.color = "#777";
          chipsWrap.appendChild(span);
          setStatus("", true);
          return;
        }

        const chips = snap.data().chips;
        chips.forEach((text) => {
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "handover-chip";
          btn.textContent = text;

          btn.addEventListener("click", async () => {
            try {
              setStatus("メモを記録中…", true);
              const businessKey = getCurrentBusinessKey();
              const deviceLabel = getDeviceLabel();
              await logsColRef.add({
                businessKey,
                deviceLabel,
                action: "handover-chip",
                taskLabel: "",
                extra: { noteText: text },
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                clientTimeISO: new Date().toISOString()
              });
              setStatus("「" + text + "」を引き継ぎメモとして記録しました。", true);
            } catch (e) {
              console.error(e);
              setStatus("メモの記録に失敗しました。", false);
            }
          });

          chipsWrap.appendChild(btn);
        });

        setStatus("", true);
      }).catch((e) => {
        console.error("handoverTemplates 読み込みエラー", e);
        setStatus("ボタンの読み込みに失敗しました。", false);
      });
    }

    // =============================
    // シフト表ボタン
    // =============================
    function initShiftButton() {
      const btn = document.getElementById("openShiftBtn");
      if (!btn) return;

      let shiftUrl = "";
      shiftDocRef.get().then((snap) => {
        if (snap.exists && snap.data().imageUrl) {
          shiftUrl = snap.data().imageUrl;
        }
      });

      btn.addEventListener("click", () => {
        if (!shiftUrl) {
          alert("シフト表のURLがまだ設定されていません。（owner画面で設定してください）");
          return;
        }
        window.open(shiftUrl, "_blank");
      });
    }

    // =============================
    // 時間帯ごとのチェックリスト
    // =============================
    async function initTimeSlots(deviceLabelFromInit) {
      const slotsContainer = document.getElementById("slotsContainer");
      const slotsStatus = document.getElementById("slotsStatus");
      const deviceInput = document.getElementById("deviceLabelInput");

      if (!slotsContainer || !slotsStatus) return;

      function setSlotsStatus(msg, ok) {
        slotsStatus.textContent = msg || "";
        slotsStatus.className = "slots-status " + (ok ? "ok" : "err");
      }

      function getDeviceLabel() {
        const v = deviceInput ? deviceInput.value.trim() : "";
        return v || "未設定";
      }

      const businessKey = getCurrentBusinessKey();

      // ① 今日の checkedIds を読み込む（営業日が古いならリセット）
      const checkedSet = new Set();
      try {
        const snap = await tasksDocRef.get();
        if (!snap.exists || snap.data().businessKey !== businessKey) {
          await tasksDocRef.set(
            { checkedIds: [], businessKey },
            { merge: true }
          );
        } else {
          const arr = Array.isArray(snap.data().checkedIds)
            ? snap.data().checkedIds
            : [];
          arr.forEach((id) => checkedSet.add(id));
        }
      } catch (e) {
        console.error("tasks/main 読み込みエラー", e);
      }

      // ② timeSlotsConfig から slots を取得
      let slots = [];
      try {
        const snap = await timeSlotsConfigRef.get();
        if (snap.exists && Array.isArray(snap.data().slots) && snap.data().slots.length > 0) {
          slots = snap.data().slots;
        } else {
          slots = getDefaultSlots();
        }
      } catch (e) {
        console.error("timeSlotsConfig 読み込みエラー", e);
        slots = getDefaultSlots();
      }

      if (!slots || slots.length === 0) {
        slotsContainer.innerHTML = "<p>時間帯の設定がありません。（owner画面で slots を設定してください）</p>";
        return;
      }

      // ③ DOM をクリアして時間帯ごとにセクション生成
      slotsContainer.innerHTML = "";
      setSlotsStatus("タスクを読み込み中…", true);

      for (const slot of slots) {
        const slotId = slot.id;
        const raw = slot._raw || "";
        let titleText = "";

        if (raw && typeof raw === "string") {
          const parts = raw.split(/\s+/, 2);
          const rangePart = parts[0];          // 06:00-09:00
          const labelPart = parts[1] || "";    // 朝の立ち上げ
          const rangeNice = rangePart.replace("-", "〜");
          titleText = labelPart ? `${rangeNice} ${labelPart}` : rangeNice;
        } else if (slot.label) {
          titleText = slot.label;
        } else {
          titleText = slotId;
        }

        // ベースDOM
        const section = document.createElement("section");
        section.className = "slot";
        section.dataset.slotId = slotId;

        const header = document.createElement("div");
        header.className = "slot-header";
        const titleEl = document.createElement("div");
        titleEl.className = "slot-title";
        titleEl.textContent = titleText;
        const labelEl = document.createElement("div");
        labelEl.className = "slot-label";
        labelEl.textContent = slot.note || "";

        header.appendChild(titleEl);
        header.appendChild(labelEl);

        const body = document.createElement("div");
        body.className = "slot-body";

        const groupA = document.createElement("div");
        const groupATitle = document.createElement("div");
        groupATitle.className = "task-group-title";
        groupATitle.innerHTML = '<span class="badge badge-a">A 必須</span> この時間に必ずやること';
        const listA = document.createElement("ul");
        listA.className = "task-list";

        groupA.appendChild(groupATitle);
        groupA.appendChild(listA);

        const groupB = document.createElement("div");
        const groupBTitle = document.createElement("div");
        groupBTitle.className = "task-group-title";
        groupBTitle.innerHTML = '<span class="badge badge-b">B 余裕</span> 時間があったときにできたら助かること';
        const listB = document.createElement("ul");
        listB.className = "task-list";

        groupB.appendChild(groupBTitle);
        groupB.appendChild(listB);

        body.appendChild(groupA);
        body.appendChild(groupB);

        section.appendChild(header);
        section.appendChild(body);
        slotsContainer.appendChild(section);

        // ④ この時間帯のタスク定義を取得
        try {
          const docSnap = await taskSlotsRef.doc(slotId).get();
          const data = docSnap.exists ? docSnap.data() || {} : {};
          const tasksA = Array.isArray(data.tasksA) ? data.tasksA : [];
          const tasksB = Array.isArray(data.tasksB) ? data.tasksB : [];

          if (tasksA.length === 0 && tasksB.length === 0) {
            const emptyA = document.createElement("li");
            emptyA.className = "task-item";
            emptyA.textContent = "（この時間帯のタスクはまだ owner 画面で設定されていません）";
            listA.appendChild(emptyA);
            continue;
          }

          // Aタスク
          tasksA.forEach((label, index) => {
            const li = document.createElement("li");
            li.className = "task-item";

            const cb = document.createElement("input");
            cb.type = "checkbox";
            const checkId = `${slotId}-A-${index}`;
            cb.checked = checkedSet.has(checkId);

            const span = document.createElement("span");
            span.textContent = label;

            cb.addEventListener("change", () => {
              onTaskToggle({
                checkId,
                checkedSet,
                checked: cb.checked,
                label,
                businessKey,
                slotId,
                deviceLabel: getDeviceLabel()
              });
            });

            li.appendChild(cb);
            li.appendChild(span);
            listA.appendChild(li);
          });

          // Bタスク
          tasksB.forEach((label, index) => {
            const li = document.createElement("li");
            li.className = "task-item";

            const cb = document.createElement("input");
            cb.type = "checkbox";
            const checkId = `${slotId}-B-${index}`;
            cb.checked = checkedSet.has(checkId);

            const span = document.createElement("span");
            span.textContent = label;

            cb.addEventListener("change", () => {
              onTaskToggle({
                checkId,
                checkedSet,
                checked: cb.checked,
                label,
                businessKey,
                slotId,
                deviceLabel: getDeviceLabel()
              });
            });

            li.appendChild(cb);
            li.appendChild(span);
            listB.appendChild(li);
          });

        } catch (e) {
          console.error(`taskSlots/${slotId} 読み込みエラー`, e);
          const li = document.createElement("li");
          li.className = "task-item";
          li.textContent = "タスクの読み込みに失敗しました。";
          listA.appendChild(li);
        }
      }

      setSlotsStatus("時間帯: " + slots.length + "枠 / 営業日: " + businessKey, true);
    }

    async function onTaskToggle(params) {
      const {
        checkId,
        checkedSet,
        checked,
        label,
        businessKey,
        slotId,
        deviceLabel
      } = params;

      try {
        if (checked) {
          checkedSet.add(checkId);
        } else {
          checkedSet.delete(checkId);
        }

        // tasks/main を更新
        await tasksDocRef.set(
          {
            checkedIds: Array.from(checkedSet),
            businessKey
          },
          { merge: true }
        );

        // ログに記録
        const actionStr = checked ? "check-on" : "check-off";
        await logsColRef.add({
          businessKey,
          deviceLabel,
          action: actionStr,
          taskLabel: label,
          slotId,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          clientTimeISO: new Date().toISOString()
        });
      } catch (e) {
        console.error("チェック更新エラー", e);
        alert("チェック状態の保存に失敗しました。ネット回線を確認してください。");
      }
    }
  </script>
</body>
</html>
