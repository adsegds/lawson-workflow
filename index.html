<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>業務チェックリスト</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
  * { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --font-small: 11px;
    --font-medium: 13px;
    --font-large: 15px;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f5f5f5;
    color: #111;
    line-height: 1.6;
    font-size: var(--font-small);
  }

  main {
    font-size: var(--font-small);
  }
  body.font-medium main {
    font-size: var(--font-medium);
  }
  body.font-large main {
    font-size: var(--font-large);
  }

  a { color: inherit; text-decoration: none; }
  button { font-family: inherit; cursor: pointer; }

  .app-shell {
    max-width: 960px;
    margin: 0 auto;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 8px 8px 16px;
  }

  .app-header {
    background: #fff;
    border-radius: 10px;
    padding: 10px 12px;
    margin-bottom: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: space-between;
    gap: 8px;
  }

  .header-left { min-width: 0; }
  .header-title {
    font-size: 16px;
    font-weight: 600;
  }
  .header-sub {
    font-size: 11px;
    color: #666;
    margin-top: 2px;
  }

  .header-right {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: flex-end;
  }

  .today-label { font-size: 11px; color: #444; white-space: nowrap; }

  .font-size-switch { display: flex; align-items: center; gap: 4px; }
  .font-size-switch span {
    font-size: 11px;
    color: #666;
  }

  .font-btn {
    border: 1px solid #ccc;
    background: #f7f7f7;
    border-radius: 999px;
    padding: 2px 6px;
    font-size: 11px;
    line-height: 1.2;
  }
  .font-btn.active {
    background: #111;
    color: #fff;
    border-color: #111;
  }

  .login-card {
    background: #fff;
    border-radius: 10px;
    padding: 14px 12px 12px;
    margin-bottom: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
  }
  .login-title {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .login-desc {
    font-size: 11px;
    color: #555;
    margin-bottom: 8px;
  }
  .login-row { margin-bottom: 8px; }
  .login-label {
    display: block;
    font-size: 11px;
    color: #555;
    margin-bottom: 2px;
  }

  .login-input {
    width: 100%;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 12px;
  }

  .login-actions {
    display: flex;
    gap: 8px;
    margin-top: 6px;
  }

  .btn-primary {
    background: #111;
    color: #fff;
    border: none;
    border-radius: 999px;
    padding: 6px 14px;
    font-size: 12px;
    font-weight: 500;
  }

  .btn-outline {
    background: #fff;
    color: #111;
    border-radius: 999px;
    padding: 6px 12px;
    font-size: 11px;
    border: 1px solid #ccc;
  }

  .login-note {
    font-size: 10px;
    color: #777;
    margin-top: 6px;
  }

  .login-status {
    font-size: 11px;
    margin-top: 4px;
  }
  .login-status.ok { color: #18794e; }
  .login-status.err { color: #b3261e; }

  .timeslot-nav-wrap {
    margin-top: 4px;
    margin-bottom: 6px;
  }
  .timeslot-nav {
    display: flex;
    gap: 4px;
    overflow-x: auto;
    padding-bottom: 2px;
  }

  .timeslot-chip {
    flex: 0 0 auto;
    border-radius: 999px;
    padding: 4px 10px;
    font-size: 11px;
    border: 1px solid #ddd;
    background: #fff;
    white-space: nowrap;
  }
  .timeslot-chip.active {
    background: #111;
    color: #fff;
    border-color: #111;
  }

  .overall-progress-card {
    background: #fff;
    border-radius: 10px;
    padding: 10px 12px 8px;
    margin-bottom: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  }
  .overall-row {
    display: flex;
    align-items: center;
    gap: 8px;
    justify-content: space-between;
    flex-wrap: wrap;
  }
  .overall-label {
    font-size: 12px;
    font-weight: 600;
  }
  .overall-value {
    font-size: 12px;
  }

  .overall-bar {
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: #eee;
    overflow: hidden;
    margin-top: 6px;
  }

  .overall-bar-inner {
    width: 0%;
    height: 100%;
    border-radius: 999px;
    background: #1f7aec;
    transition: width 0.15s ease-out;
  }

  .slot-section {
    background: #fff;
    border-radius: 10px;
    padding: 10px 10px 8px;
    margin-bottom: 8px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.04);
  }

  .slot-header {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    align-items: center;
    margin-bottom: 6px;
  }

  .slot-title {
    font-size: 13px;
    font-weight: 600;
  }

  .slot-meta {
    font-size: 11px;
    color: #666;
  }

  .slot-progress {
    margin-top: 8px;
    padding-top: 4px;
    border-top: 1px solid #eee;
    width: 100%;
  }

  .slot-progress-label {
    font-size: 11px;
    color: #666;
    margin-bottom: 2px;
  }

  .slot-progress-bar {
    width: 100%;
    height: 6px;
    border-radius: 999px;
    background: #eee;
    overflow: hidden;
  }

  .slot-progress-bar-inner {
    height: 100%;
    width: 0%;
    border-radius: 999px;
    background: #1f7aec;
    transition: width 0.15s ease-out;
  }

  .task-list { list-style: none; }

  .task-item {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    padding: 6px 0;
    border-bottom: 1px solid #f0f0f0;
  }
  .task-item:last-child { border-bottom: none; }

  .task-checkbox { margin-top: 2px; }

  .task-main { flex: 1; min-width: 0; }

  .task-title-row {
    display: flex;
    justify-content: space-between;
    gap: 6px;
    align-items: center;
    margin-bottom: 1px;
  }

  .task-title {
    font-size: 12px;
    font-weight: 500;
  }

  .task-tag {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 999px;
    background: #f1f5f9;
    color: #334155;
    white-space: nowrap;
  }

  .task-note {
    font-size: 11px;
    color: #666;
  }

  .task-done .task-title {
    text-decoration: line-through;
    color: #888;
  }
  .task-done .task-note {
    color: #aaa;
  }

  .info-message {
    font-size: 11px;
    color: #666;
    margin-top: 4px;
  }

  .hidden { display: none !important; }
  </style>

  <!-- ★ 簡易パクられ対策（完全には防げないけど、ちょっとだけ面倒にする） -->
  <script>
    // 右クリック禁止
    document.addEventListener("contextmenu", function (e) {
      e.preventDefault();
    });

    // 一部ショートカット（F12, Ctrl+Shift+I, Ctrl+U など）無効
    document.addEventListener("keydown", function (e) {
      const k = e.key.toLowerCase();
      if (k === "f12") e.preventDefault();
      if (e.ctrlKey && e.shiftKey && (k === "i" || k === "j" || k === "c")) e.preventDefault();
      if (e.ctrlKey && (k === "u" || k === "s" || k === "p")) e.preventDefault();
    });
  </script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body>
  <div class="app-shell">

    <!-- ================== ヘッダー ================== -->
    <header class="app-header">
      <div class="header-left">
        <div class="header-title">業務チェックリスト</div>
        <div class="header-sub" id="storeLabel">
          店舗ID未設定 / スタッフ用
        </div>
      </div>

      <div class="header-right">
        <div class="today-label" id="todayLabel"></div>

        <div class="font-size-switch">
          <span>文字サイズ</span>
          <button type="button" class="font-btn active" data-size="small">小</button>
          <button type="button" class="font-btn" data-size="medium">中</button>
          <button type="button" class="font-btn" data-size="large">大</button>
        </div>
      </div>
    </header>

    <!-- ================== メイン ================== -->
    <main>

      <!-- ===== ログインカード ===== -->
      <section class="login-card" id="loginSection">
        <div class="login-title">店舗ログイン</div>
        <div class="login-desc">
          店舗IDとスタッフ用パスワードを入力して、今日の業務チェックを表示します。
        </div>

        <div class="login-row">
          <label for="storeIdInput" class="login-label">店舗ID</label>
          <input id="storeIdInput" class="login-input" type="text"
            placeholder="例）nanbu-lawson-01" />
        </div>

        <div class="login-row">
          <label for="staffPassInput" class="login-label">スタッフ用パスワード</label>
          <input id="staffPassInput" class="login-input" type="password"
            autocomplete="current-password" />
        </div>

        <div class="login-actions">
          <button type="button" class="btn-primary" id="loginButton">ログイン</button>
          <button type="button" class="btn-outline" id="clearSavedButton">端末の保存情報を削除</button>
        </div>

        <div class="login-status" id="loginStatus"></div>

        <div class="login-note">
          ※一度ログインすると、この端末に店舗IDが保存されます（レジ裏スマホなど想定）。
        </div>
      </section>


      <!-- ===== 時間帯チップ（ログイン後に表示） ===== -->
      <section class="timeslot-nav-wrap hidden" id="timeslotNavWrap">
        <div class="timeslot-nav" id="timeslotNav"></div>
      </section>

      <!-- ===== 全体の進捗カード ===== -->
      <section class="overall-progress-card hidden" id="overallCard">
        <div class="overall-row">
          <span class="overall-label">全体の完了率</span>
          <span class="overall-value" id="overallValue">0%</span>
        </div>

        <div class="overall-bar">
          <div class="overall-bar-inner" id="overallBar"></div>
        </div>
      </section>

      <!-- ===== 各時間帯セクション（ここに JS で生成） ===== -->
      <div id="slotContainer"></div>

    </main>

  </div> <!-- app-shell ここまで -->

  <!-- ================== Firebase 初期化 ================== -->
  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>

  <!-- ================== ここから JS 本体 ================== -->
  <script>
    // 今日の日付表示
    const todayLabel = document.getElementById("todayLabel");
    const today = new Date();
    todayLabel.textContent = `${today.getMonth()+1}月${today.getDate()}日（${["日","月","火","水","木","金","土"][today.getDay()]}）`;

    // 保存情報
    const storeIdInput = document.getElementById("storeIdInput");
    const staffPassInput = document.getElementById("staffPassInput");
    const loginStatus = document.getElementById("loginStatus");

    const savedStore = localStorage.getItem("storeId");
    if (savedStore) {
      storeIdInput.value = savedStore;
    }

    document.getElementById("clearSavedButton").addEventListener("click", () => {
      localStorage.removeItem("storeId");
      storeIdInput.value = "";
      loginStatus.textContent = "保存された端末情報を削除しました。";
      loginStatus.className = "login-status ok";
    });

    // ======================
    // ★ ログイン処理
    // ======================
    document.getElementById("loginButton").addEventListener("click", async () => {
      const storeId = storeIdInput.value.trim();
      const pass = staffPassInput.value.trim();
      if (!storeId || !pass) {
        loginStatus.textContent = "店舗ID と パスワードを入力してください。";
        loginStatus.className = "login-status err";
        return;
      }

      try {
        const doc = await db.collection("stores").doc(storeId).collection("settings").doc("auth").get();
        if (!doc.exists) {
          loginStatus.textContent = "店舗ID が存在しません。";
          loginStatus.className = "login-status err";
          return;
        }

        const data = doc.data();
        if (data.staffPass !== pass) {
          loginStatus.textContent = "パスワードが違います。";
          loginStatus.className = "login-status err";
          return;
        }

        // OK
        localStorage.setItem("storeId", storeId);

        loginStatus.textContent = "ログイン成功！読み込み中…";
        loginStatus.className = "login-status ok";

        // 読み込み実行
        startChecklist(storeId);

      } catch (err) {
        console.error(err);
        loginStatus.textContent = "エラーが発生しました。";
        loginStatus.className = "login-status err";
      }
    });

    // ======================
    // ★ チェックリスト開始
    // ======================
    async function startChecklist(storeId) {
      // ログイン画面を非表示
      document.getElementById("loginSection").classList.add("hidden");

      // 店舗名ラベル
      document.getElementById("storeLabel").textContent = `${storeId} / スタッフ用`;

      // 時間帯設定ロード
      const slotIds = await loadTimeSlots(storeId);

      // 時間帯チップ作成
      renderTimeSlotChips(slotIds);

      // タスク読み込み
      loadTasks(storeId, slotIds);
    }

    // ======================
    // ★ 時間帯設定読み込み
    // ======================
    async function loadTimeSlots(storeId) {
      try {
        const doc = await db.collection("stores").doc(storeId).collection("settings").doc("timeSlots").get();
        if (doc.exists) {
          const data = doc.data();
          if (Array.isArray(data.slots) && data.slots.length > 0) {
            return data.slots;  // 例: ["t6-8","t9-11", ...]
          }
        }
      } catch(e){}

      // デフォルト時間帯
      return ["t6-8","t9-11","t12-14","t15-17","t18-20","t21-23","t0-2","t3-5"];
    }

    // ======================
    // ★ 時間帯チップ描画
    // ======================
    function renderTimeSlotChips(slotIds) {
      const wrap = document.getElementById("timeslotNavWrap");
      const nav = document.getElementById("timeslotNav");

      wrap.classList.remove("hidden");
      nav.innerHTML = "";

      slotIds.forEach((slot, i) => {
        const btn = document.createElement("button");
        btn.className = "timeslot-chip" + (i === 0 ? " active" : "");
        btn.dataset.slot = slot;
        btn.textContent = slot.replace("t","").replace("-","〜");
        nav.appendChild(btn);
      });
    }



    // ======================
    // ★ タスク読み込み
    // ======================
    async function loadTasks(storeId, slotIds) {
      const container = document.getElementById("slotContainer");
      container.innerHTML = "";

      // データ読み込み
      const tasksSnap = await db
        .collection("stores").doc(storeId)
        .collection("tasks")
        .get();

      const tasks = {};
      tasksSnap.forEach(doc => {
        tasks[doc.id] = doc.data();
      });

      // セクション生成
      slotIds.forEach(slotId => {
        const slotData = tasks[slotId] || { tasks: [] };
        container.appendChild(createSlotSection(storeId, slotId, slotData));
      });

      // 時間帯全体進捗を更新
      updateOverallProgress();
    }

    // ======================
    // ★ 各時間帯の HTML 生成
    // ======================
    function createSlotSection(storeId, slotId, slotData) {
      const section = document.createElement("section");
      section.className = "slot-section";

      section.innerHTML = `
        <div class="slot-header">
          <div class="slot-title">${slotId.replace("t","").replace("-","〜")}</div>
          <div class="slot-meta">全${slotData.tasks.length}件</div>
        </div>

        <ul class="task-list">
          ${slotData.tasks.map((t, idx) => `
            <li class="task-item ${t.done ? "task-done" : ""}">
              <input type="checkbox" class="task-checkbox" data-slot="${slotId}" data-index="${idx}" ${t.done ? "checked" : ""}/>
              <div class="task-main">
                <div class="task-title-row">
                  <span class="task-title">${t.title || "(無題タスク)"}</span>
                  ${t.tag ? `<span class="task-tag">${t.tag}</span>` : ""}
                </div>
                ${t.note ? `<div class="task-note">${t.note}</div>` : ""}
              </div>
            </li>
          `).join("")}
        </ul>

        <div class="slot-progress">
          <div class="slot-progress-label">完了率</div>
          <div class="slot-progress-bar">
            <div class="slot-progress-bar-inner" id="bar-${slotId}"></div>
          </div>
        </div>
      `;

      // 初期進捗を反映
      requestAnimationFrame(() => {
        updateSlotProgress(slotId, slotData);
      });

      // チェックイベント
      section.querySelectorAll(".task-checkbox").forEach(cb => {
        cb.addEventListener("change", async (e) => {
          const slot = e.target.dataset.slot;
          const index = Number(e.target.dataset.index);
          const done = e.target.checked;

          await updateTaskDone(storeId, slot, index, done);

          // UI 更新
          if (done) {
            e.target.closest(".task-item").classList.add("task-done");
          } else {
            e.target.closest(".task-item").classList.remove("task-done");
          }

          // 進捗更新
          const currentData = await fetchSlot(storeId, slot);
          updateSlotProgress(slot, currentData);
          updateOverallProgress();
        });
      });

      return section;
    }

    // ======================
    // ★ Firestore の特定時間帯を再取得
    // ======================
    async function fetchSlot(storeId, slotId) {
      const doc = await db
        .collection("stores").doc(storeId)
        .collection("tasks").doc(slotId)
        .get();
      return doc.data() || { tasks: [] };
    }

    // ======================
    // ★ チェック状態を Firestore へ保存
    // ======================
    async function updateTaskDone(storeId, slotId, index, done) {
      const ref = db.collection("stores").doc(storeId).collection("tasks").doc(slotId);

      await ref.update({
        [`tasks.${index}.done`]: done
      });
    }

    // ======================
    // ★ 時間帯ごとの完了率更新
    // ======================
    function updateSlotProgress(slotId, slotData) {
      const tasks = slotData.tasks || [];
      const doneCount = tasks.filter(t => t.done).length;
      const rate = tasks.length === 0 ? 0 : Math.round(doneCount / tasks.length * 100);

      const bar = document.getElementById(`bar-${slotId}`);
      if (bar) bar.style.width = rate + "%";
    }

    // ======================
    // ★ 全体の完了率
    // ======================
    function updateOverallProgress() {
      const sections = document.querySelectorAll(".slot-section");

      let total = 0;
      let done = 0;

      sections.forEach(sec => {
        const checkboxes = sec.querySelectorAll(".task-checkbox");
        checkboxes.forEach(cb => {
          total++;
          if (cb.checked) done++;
        });
      });

      const rate = total === 0 ? 0 : Math.round(done / total * 100);

      document.getElementById("overallValue").textContent = `${rate}%`;
      document.getElementById("overallBar").style.width = `${rate}%`;
      document.getElementById("overallCard").classList.remove("hidden");
    }


    // ======================
    // ★ 文字サイズ切り替え
    // ======================
    document.querySelectorAll(".font-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.body.classList.remove("font-small","font-medium","font-large");

        const size = btn.dataset.size;
        document.body.classList.add(`font-${size}`);

        document.querySelectorAll(".font-btn").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    // ======================
    // ★ 各時間帯チップを押したらスクロール
    // ======================
    document.getElementById("timeslotNav").addEventListener("click", (e) => {
      if (!e.target.classList.contains("timeslot-chip")) return;

      const slot = e.target.dataset.slot;

      // チップの active 切替
      document.querySelectorAll(".timeslot-chip").forEach(btn => btn.classList.remove("active"));
      e.target.classList.add("active");

      // 対応する時間帯セクションにスクロール
      const sections = [...document.querySelectorAll(".slot-section")];
      const target = sections.find(sec => sec.querySelector(`#bar-${slot}`));
      if (target) {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    });

    // ======================
    // ★ 追加パクられ対策（console を一部ハック）
    // ======================
    (function() {
      const original = console.log;
      console.log = function(...msg) {
        if (msg.some(m => typeof m === "string" && m.includes("<html"))) return;
        original.apply(console, msg);
      };
    })();
  </script>

</body>
</html>
