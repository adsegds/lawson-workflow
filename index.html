<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å—éƒ¨ç”ºãƒ­ãƒ¼ã‚½ãƒ³ æ¥­å‹™ãƒã‚§ãƒƒã‚¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #f5f5f5;
    color: #111;
    line-height: 1.6;
  }

  /* å¹…åºƒã‚ */
  .app {
    max-width: 1400px;
    margin: 0 auto;
    padding-bottom: 80px;
  }

  header {
    position: sticky;
    top: 0;
    z-index: 10;
    background: #111;
    color: #fff;
    padding: 10px 14px;
  }
  header h1 {
    font-size: 16px;
    font-weight: 600;
  }
  header p {
    font-size: 11px;
    opacity: 0.85;
    margin-top: 2px;
  }

  /* ãƒŠãƒ“ï¼ˆæ™‚é–“å¸¯ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰ */
  .nav {
    display: flex;
    overflow-x: auto;
    gap: 6px;
    padding: 8px 10px 4px;
    background: #222;
    scrollbar-width: none;
  }
  .nav::-webkit-scrollbar { display: none; }
  .nav a {
    flex: 0 0 auto;
    padding: 4px 8px;
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid #555;
    color: #eee;
    text-decoration: none;
    white-space: nowrap;
  }
  .nav a:hover {
    background: #fff;
    color: #111;
  }

  main { padding: 10px 12px 20px; }

  .slot {
    margin-bottom: 12px;
    background: #fff;
    border-radius: 10px;
    padding: 10px 10px 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.06);
  }

  .slot-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
    border-bottom: 1px solid #eee;
    padding-bottom: 4px;
  }
  .slot-title {
    font-size: 14px;
    font-weight: 600;
  }
  .slot-note {
    font-size: 10px;
    color: #666;
  }

  .tasks-group {
    margin-top: 6px;
  }
  .tasks-group h3 {
    font-size: 12px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-bottom: 4px;
  }
  .badge {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: 999px;
  }
  .badge-a {
    background: #111;
    color: #fff;
  }
  .badge-b {
    background: #e0e0e0;
    color: #333;
  }

  ul.tasks {
    list-style: none;
    padding-left: 10px;
    border-left: 2px solid #111;
    margin-bottom: 4px;
  }
  ul.tasks.b {
    border-left-color: #bbb;
  }

  /* liâ†’ãƒã‚§ãƒƒã‚¯ä»˜ãã®è¡Œ */
  .task-item {
    display: flex;
    align-items: flex-start;
    gap: 6px;
    font-size: 11px;
    padding: 2px 0;
  }
  .task-item input[type="checkbox"] {
    margin-top: 2px;
  }
  .task-text {
    flex: 1;
  }

  .footer-note {
    font-size: 10px;
    color: #666;
    padding: 6px 4px 20px;
    text-align: center;
  }

  /* ===== ãŠçŸ¥ã‚‰ã›ãƒ»å¼•ãç¶™ãç”¨ ===== */

  .info-list {
    list-style: none;
    font-size: 11px;
    padding-left: 4px;
  }
  .info-list li {
    padding: 2px 0;
  }

  .handover {
    margin-top: 4px;
  }
  .handover-title {
    font-size: 13px;
    font-weight: 600;
    margin-bottom: 4px;
  }
  .handover-note {
    font-size: 10px;
    color: #666;
    margin-bottom: 4px;
  }

  .handover-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    margin-bottom: 6px;
  }
  .handover-chips button {
    border: 1px solid #ccc;
    border-radius: 999px;
    padding: 3px 8px;
    font-size: 10px;
    background: #fafafa;
    cursor: pointer;
  }
  .handover-chips button:hover {
    background: #eee;
  }

  .handover-log {
    list-style: none;
    font-size: 11px;
    border-top: 1px dashed #ddd;
    padding-top: 4px;
  }
  .handover-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 2px 0;
  }
  .handover-text {
    flex: 1;
    margin-right: 6px;
  }
  .handover-time {
    font-size: 10px;
    color: #666;
    margin-right: 4px;
  }
  .handover-remove {
    border: none;
    background: transparent;
    font-size: 12px;
    cursor: pointer;
    color: #999;
  }
  .handover-remove:hover {
    color: #f33;
  }

  .handover-clear {
    margin-top: 4px;
    text-align: right;
  }
  .handover-clear button {
    border: none;
    background: #eee;
    border-radius: 999px;
    padding: 2px 8px;
    font-size: 10px;
    cursor: pointer;
  }

  /* â˜…â˜… ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
  .font-size-selector {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    margin-top: 6px;
  }
  .font-size-selector button {
    border-radius: 999px;
    border: 1px solid #666;
    padding: 2px 10px;
    font-size: 11px;
    background: #111;
    color: #eee;
    cursor: pointer;
    opacity: 0.7;
  }
  .font-size-selector button.active {
    background: #fff;
    color: #111;
    opacity: 1;
  }

  /* â˜…â˜… ãƒ™ãƒ¼ã‚¹ãƒ•ã‚©ãƒ³ãƒˆå€ç‡ï¼ˆbody å…¨ä½“ã«å½±éŸ¿ã•ã›ã‚‹ï¼‰ */
  body.font-small  { font-size: 13px; }
  body.font-medium { font-size: 15px; }
  body.font-large  { font-size: 17px; }

  /* æ—¢å­˜ã® px æŒ‡å®šã¯ãã®ã¾ã¾ã§ã‚‚ã€è¡Œé–“ã‚„ä½™ç™½ãŒå°‘ã—åºƒããªã£ã¦è¦‹ã‚„ã™ããªã‚‹æƒ³å®š */
  </style>
</head>
<body class="font-small"><!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼å° -->

  <div class="app">
    <header>
      <h1>å—éƒ¨ç”ºãƒ­ãƒ¼ã‚½ãƒ³ æ¥­å‹™ãƒã‚§ãƒƒã‚¯</h1>
      <p>æ™‚é–“å¸¯ã”ã¨ã® Aï¼å¿…é ˆ / Bï¼ä½™è£•ã‚ã‚Œã°ã€‚è¿·ã£ãŸã‚‰Aã‹ã‚‰ã€‚</p>
      <nav class="nav">
        <a href="#t6-8">6ã€œ8æ™‚</a>
        <a href="#t9-11">9ã€œ11æ™‚</a>
        <a href="#t12-14">12ã€œ14æ™‚</a>
        <a href="#t15-17">15ã€œ17æ™‚</a>
        <a href="#t18-20">18ã€œ20æ™‚</a>
        <a href="#t21-23">21ã€œ23æ™‚</a>
        <a href="#t0-2">0ã€œ2æ™‚</a>
        <a href="#t3-5">3ã€œ5æ™‚</a>
      </nav>

      <!-- â˜…â˜… ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºåˆ‡ã‚Šæ›¿ãˆ -->
      <div class="font-size-selector">
        <button data-size="small"  class="active">å°</button>
        <button data-size="medium">ä¸­</button>
        <button data-size="large">å¤§</button>
      </div>
    </header>

    <main>
      <!-- ç¾åœ¨æ™‚åˆ»è¡¨ç¤º -->
      <div id="time-display" style="padding: 10px; font-size: 14px; color: #333;">
        æ™‚åˆ»ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦
      </div>

      <!-- â˜… ãŠçŸ¥ã‚‰ã›ï¼ˆçµŒå–¶è€…å°‚ç”¨ ownerNewsï¼‰â˜… -->
      <section class="slot">
        <div class="slot-header">
          <div class="slot-title">ãŠçŸ¥ã‚‰ã›</div>
          <div class="slot-note">çµŒå–¶è€…ã‹ã‚‰ã®å…±æœ‰äº‹é …</div>
        </div>
        <div class="tasks-group">
          <h3><span class="badge badge-a">ãŠçŸ¥ã‚‰ã›</span></h3>
          <ul class="info-list" id="notice-list">
            <li>ãŠçŸ¥ã‚‰ã›ã‚’èª­ã¿è¾¼ã¿ä¸­...</li>
          </ul>
        </div>
      </section>

      <!-- 6ã€œ8æ™‚ -->
      <!-- ï¼ˆä»¥ä¸‹ã€ã‚ãªãŸãŒè²¼ã£ã¦ãã‚ŒãŸã‚¿ã‚¹ã‚¯éƒ¨åˆ†ã¯ãã®ã¾ã¾ãªã®ã§çœç•¥â€¦ï¼‰ -->
      <!-- ãƒ»ãƒ»ãƒ»ä¸­ç•¥ãƒ»ãƒ»ãƒ» -->
      <!-- 3ã€œ5æ™‚ã¾ã§å…¨éƒ¨ä¸€ç·’ -->

      <!-- ã“ã“ã¾ã§ã‚¿ã‚¹ã‚¯ï¼†å¼•ãç¶™ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å…ƒã®ã¾ã¾ã‚³ãƒ”ãƒšã—ã¦ãã ã•ã„ -->
      <!-- çœç•¥ã—ãŸéƒ¨åˆ†ã¯ã€ã‚ãªãŸã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ãã®ã¾ã¾å…¥ã‚Œã¦ã­ -->
    </main>

    <div class="footer-note">
      è¿·ã£ãŸã‚‰ï¼šAã‚¿ã‚¹ã‚¯ â†’ å‰é™³ â†’ æ¸…æƒ ã®é †ã§å‹•ã‘ã°OKã€‚
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
    // =============================
    // Firebase è¨­å®š
    // =============================
    const firebaseConfig = {
      apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
      authDomain: "lawson-workflow.firebaseapp.com",
      projectId: "lawson-workflow",
      storageBucket: "lawson-workflow.firebasestorage.app",
      messagingSenderId: "335371795694",
      appId: "1:335371795694:web:3b0950a616d368b284c7ff",
      measurementId: "G-BGENZNZMRC"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // â˜…â˜… ã“ã®ç«¯æœ«ã®ãƒ©ãƒ™ãƒ«ï¼ˆPCã”ã¨ã«å¤‰ãˆã¦OKï¼‰
    //    ä¾‹ï¼‰"ãƒ¬ã‚¸å‰PC" / "äº‹å‹™æ‰€PC" / "ãƒ¬ã‚¸æ¨ªã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ"
    const DEVICE_LABEL = "ãƒ¬ã‚¸å‰PC";

    // =============================
    // å–¶æ¥­æ—¥ã‚­ãƒ¼è¨ˆç®—ï¼ˆ6:00åˆ‡ã‚Šæ›¿ãˆï¼‰
    // =============================
    function getCurrentBusinessKey() {
      const now = new Date(); // åº—ã®PCãŒæ—¥æœ¬æ™‚é–“ãªã‚‰ãã®ã¾ã¾JST
      const y = now.getFullYear();
      const m = now.getMonth();
      const d = now.getDate();

      const base = new Date(y, m, d);

      // 0:00ã€œ5:59 ã¯ã€Œå‰æ—¥æ‰±ã„ã€
      if (now.getHours() < 6) {
        base.setDate(base.getDate() - 1);
      }

      const yy = base.getFullYear();
      const mm = String(base.getMonth() + 1).padStart(2, '0');
      const dd = String(base.getDate()).padStart(2, '0');
      return `${yy}-${mm}-${dd}`; // ä¾‹: "2025-11-22"
    }

    // â˜…â˜… ä»ŠãŒã©ã®æ™‚é–“å¸¯ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚’è¿”ã™
    function getCurrentSlotId() {
      const h = new Date().getHours();
      if (h >= 6 && h < 9)   return "t6-8";
      if (h >= 9 && h < 12)  return "t9-11";
      if (h >= 12 && h < 15) return "t12-14";
      if (h >= 15 && h < 18) return "t15-17";
      if (h >= 18 && h < 21) return "t18-20";
      if (h >= 21)           return "t21-23";
      if (h >= 0 && h < 3)   return "t0-2";
      if (h >= 3 && h < 6)   return "t3-5";
      return null;
    }

    /****************************************************
     * ğŸ”¥ 6:00 è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼šãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿ï¼‰
     ****************************************************/
    function setupDailyResetAt6AM() {
      function scheduleNextReset() {
        const now = new Date();
        const next = new Date();

        // æ¬¡ã® 6:00 ã‚’è¨ˆç®—
        next.setHours(6, 0, 0, 0);
        if (now >= next) {
          next.setDate(next.getDate() + 1); // ä»Šæ—¥ã®6æ™‚ã‚’éãã¦ãŸã‚‰ç¿Œæ—¥
        }

        const ms = next - now;
        console.log('æ¬¡ã® 6:00 ãƒªã‚»ãƒƒãƒˆã¾ã§:', ms / 1000 / 60, 'åˆ†');

        setTimeout(() => {
          console.log('ğŸ”¥ 6:00åˆ°é” â†’ å–¶æ¥­æ—¥åˆ‡æ›¿ã®ãŸã‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿');
          on6amReset();
          scheduleNextReset(); // æ¬¡ã®æ—¥ã® 6:00 ã‚‚ã‚»ãƒƒãƒˆ
        }, ms);
      }

      scheduleNextReset();
    }

    function on6amReset() {
      location.reload();
    }

    // â˜…â˜… ã“ã®ç«¯æœ«ãƒ»ã“ã®å–¶æ¥­æ—¥ãƒ»ã“ã®æ™‚é–“å¸¯ã‚¹ãƒ­ãƒƒãƒˆã§
    //    ã¾ã  attendance ãŒç„¡ã‘ã‚Œã° 1ä»¶ã ã‘ç™»éŒ²ã™ã‚‹
    async function recordAttendanceOncePerSlot() {
      const businessKey = getCurrentBusinessKey();
      const slotId = getCurrentSlotId();
      if (!slotId) return;

      try {
        const ref = db.collection("attendance");

        const snap = await ref
          .where("businessKey", "==", businessKey)
          .where("slotId", "==", slotId)
          .where("device", "==", DEVICE_LABEL)
          .limit(1)
          .get();

        if (snap.empty) {
          await ref.add({
            businessKey,
            slotId,
            device: DEVICE_LABEL,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log("å‡ºå‹¤ãƒ­ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ:", businessKey, slotId, DEVICE_LABEL);
        } else {
          console.log("ã™ã§ã«å‡ºå‹¤ãƒ­ã‚°ã‚ã‚Š:", businessKey, slotId, DEVICE_LABEL);
        }
      } catch (e) {
        console.error("attendance ç™»éŒ²ã‚¨ãƒ©ãƒ¼", e);
      }
    }

    // =============================
    // DOM æº–å‚™ã§ããŸã‚‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
    // =============================
    document.addEventListener('DOMContentLoaded', () => {

      // ğŸ”¥ æœ6:00 è‡ªå‹•ãƒªã‚»ãƒƒãƒˆé–‹å§‹
      setupDailyResetAt6AM();

      // =============================
      // ç¾åœ¨æ™‚åˆ»ãƒ»å–¶æ¥­æ—¥ãƒ»æ¬¡ãƒªã‚»ãƒƒãƒˆè¡¨ç¤º
      // =============================
      const timeDisplay = document.getElementById('time-display');

      function updateTimeDisplay() {
        if (!timeDisplay) return;

        const now = new Date();
        const jp = now.toLocaleString('ja-JP', {
          year: 'numeric',
          month: '2-digit',
          day: '2-digit',
          weekday: 'short',
          hour: '2-digit',
          minute: '2-digit',
          second: '2-digit'
        });

        const businessKey = getCurrentBusinessKey();

        // æ¬¡ã® 6:00 ã‚’è¨ˆç®—
        let nextReset = new Date();
        nextReset.setHours(6, 0, 0, 0);
        if (now >= nextReset) {
          nextReset.setDate(nextReset.getDate() + 1);
        }
        const nextResetStr = nextReset.toLocaleString('ja-JP', {
          month: '2-digit',
          day: '2-digit',
          weekday: 'short',
          hour: '2-digit',
          minute: '2-digit'
        });

        timeDisplay.innerHTML = `
          <div><strong>ç¾åœ¨æ™‚åˆ»ï¼š</strong> ${jp}</div>
          <div><strong>ä»Šæ—¥ã®å–¶æ¥­æ—¥ï¼š</strong> ${businessKey}ï¼ˆ6:00åˆ‡æ›¿ï¼‰</div>
          <div><strong>æ¬¡ã®ãƒªã‚»ãƒƒãƒˆï¼š</strong> ${nextResetStr}</div>
        `;
      }

      updateTimeDisplay();
      setInterval(updateTimeDisplay, 1000);

      // â˜…â˜… ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºåˆ‡ã‚Šæ›¿ãˆ
      const sizeButtons = document.querySelectorAll('.font-size-selector button');
      sizeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const size = btn.dataset.size;
          document.body.classList.remove('font-small', 'font-medium', 'font-large');
          document.body.classList.add(`font-${size}`);
          sizeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });

      // --------------------------------
      // 1) ã‚¿ã‚¹ã‚¯å®šç¾©ï¼ˆtaskSlotsï¼‰ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
      // --------------------------------
      const timeSlotIds = ['t6-8', 't9-11', 't12-14', 't15-17', 't18-20', 't21-23', 't0-2', 't3-5'];
      const checkboxMap = new Map();
      let latestCheckedIds = new Set();
      const taskDocRef = db.collection('tasks').doc('lawson-main');
      let applyingRemote = false;

      function buildTasksFromDefinition(slotId, ul, tasks, groupLabel) {
        ul.innerHTML = '';
        tasks.forEach((text, index) => {
          const li = document.createElement('li');
          li.innerHTML = `
            <label class="task-item">
              <input type="checkbox">
              <span class="task-text"></span>
            </label>
          `;
          const cb   = li.querySelector('input[type="checkbox"]');
          const span = li.querySelector('.task-text');
          span.textContent = text;

          const taskId = `${slotId}-${groupLabel}-${index}`;
          cb.dataset.taskId = taskId;
          checkboxMap.set(taskId, cb);

          cb.checked = latestCheckedIds.has(taskId);

          ul.appendChild(li);
        });
      }

      async function loadTaskDefinitions() {
        const taskSlotsRef = db.collection('taskSlots');

        await Promise.all(
          timeSlotIds.map(async (slotId) => {
            const section = document.getElementById(slotId);
            if (!section) return;

            const ulA = section.querySelector('ul.tasks.a');
            const ulB = section.querySelector('ul.tasks.b');
            if (!ulA || !ulB) return;

            try {
              const snap = await taskSlotsRef.doc(slotId).get();
              if (snap.exists) {
                const data = snap.data() || {};
                const tasksA = data.tasksA || [];
                const tasksB = data.tasksB || [];

                buildTasksFromDefinition(slotId, ulA, tasksA, 'A');
                buildTasksFromDefinition(slotId, ulB, tasksB, 'B');
              } else {
                const setupFromExisting = (ul, groupLabel) => {
                  const lis = ul.querySelectorAll('li');
                  lis.forEach((li, index) => {
                    const cb = li.querySelector('input[type="checkbox"]');
                    if (!cb) return;
                    const taskId = `${slotId}-${groupLabel}-${index}`;
                    cb.dataset.taskId = taskId;
                    checkboxMap.set(taskId, cb);
                    cb.checked = latestCheckedIds.has(taskId);
                  });
                };
                setupFromExisting(ulA, 'A');
                setupFromExisting(ulB, 'B');
              }
            } catch (e) {
              console.error('ã‚¿ã‚¹ã‚¯å®šç¾©èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', slotId, e);
            }
          })
        );
      }

      // --------------------------------
      // 2) ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ â†” Firestore åŒæœŸ
      // --------------------------------
      function saveTasksToFirestore() {
        const checkedIds = [];
        checkboxMap.forEach((cb, id) => {
          if (cb.checked) checkedIds.push(id);
        });
        const businessKey = getCurrentBusinessKey();
        taskDocRef.set(
          { checkedIds, businessKey },
          { merge: true }
        );
      }

      taskDocRef.onSnapshot((doc) => {
        const data = doc.exists ? doc.data() : {};
        const storedKey  = data.businessKey;
        const currentKey = getCurrentBusinessKey();

        if (storedKey !== currentKey) {
          taskDocRef.set(
            { checkedIds: [], businessKey: currentKey },
            { merge: true }
          );
          latestCheckedIds = new Set();
        } else {
          latestCheckedIds = new Set(data.checkedIds || []);
        }

        applyingRemote = true;
        checkboxMap.forEach((cb, id) => {
          cb.checked = latestCheckedIds.has(id);
        });
        applyingRemote = false;
      });

      document.body.addEventListener('change', (e) => {
        const target = e.target;
        if (!target.matches('input[type="checkbox"][data-task-id]')) return;
        if (applyingRemote) return;
        saveTasksToFirestore();
      });

      loadTaskDefinitions();

      // --------------------------------
      // 3) å¼•ãç¶™ããƒ¡ãƒ¢
      // --------------------------------
      const handoverSlots  = document.querySelectorAll('.handover-slot');
      const handoverColRef = db.collection('handover');

      function renderHandoverForSlot(snapshot, logEl, slotId) {
        if (!logEl) return;

        logEl.innerHTML = '';

        if (snapshot.empty) {
          const li = document.createElement('li');
          li.textContent = 'ã¾ã å¼•ãç¶™ããƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
          li.style.fontSize = '10px';
          li.style.color = '#999';
          logEl.appendChild(li);
          return;
        }

        const docs = [];
        snapshot.forEach((doc) => {
          docs.push(doc);
        });

        docs.sort((a, b) => {
          const da = a.data().createdAt ? a.data().createdAt.toMillis() : 0;
          const db = b.data().createdAt ? b.data().createdAt.toMillis() : 0;
          return db - da;
        });

        docs.forEach((doc) => {
          const data = doc.data();
          if (data.slotId !== slotId) return;

          const li = document.createElement('li');
          li.className = 'handover-item';

          const textSpan = document.createElement('span');
          textSpan.className = 'handover-text';
          textSpan.textContent = data.text || '';

          const timeSpan = document.createElement('span');
          timeSpan.className = 'handover-time';
          timeSpan.textContent = data.timeLabel || '';

          const delBtn = document.createElement('button');
          delBtn.className = 'handover-remove';
          delBtn.textContent = 'âœ•';
          delBtn.addEventListener('click', () => {
            doc.ref.delete();
          });

          li.appendChild(textSpan);
          li.appendChild(timeSpan);
          li.appendChild(delBtn);

          logEl.appendChild(li);
        });
      }

      handoverSlots.forEach((slotEl) => {
        const slotId   = slotEl.dataset.slot || 'global';
        const logEl    = slotEl.querySelector('.handover-log');
        const clearBtn = slotEl.querySelector('.handover-clear-btn');
        const chipsArea = slotEl.querySelector('.handover-chips');

        handoverColRef
          .where('businessKey', '==', getCurrentBusinessKey())
          .where('slotId', '==', slotId)
          .onSnapshot((snapshot) => {
            renderHandoverForSlot(snapshot, logEl, slotId);
          });

        function addHandoverForSlot(text) {
          const now = new Date();
          const timeLabel = now.toLocaleTimeString('ja-JP', {
            hour: '2-digit',
            minute: '2-digit'
          });

          const businessKey = getCurrentBusinessKey();

          handoverColRef.add({
            text,
            slotId,
            businessKey,
            timeLabel,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        if (chipsArea) {
          db.collection("handoverTemplates")
            .doc("global")
            .get()
            .then((doc) => {
              chipsArea.innerHTML = "";

              if (!doc.exists) return;

              const chips = doc.data().chips || [];
              chips.forEach((text) => {
                const btn = document.createElement("button");
                btn.className = "handover-chip";
                btn.textContent = text;
                btn.dataset.text = text;

                btn.addEventListener("click", () => {
                  addHandoverForSlot(text);
                });

                chipsArea.appendChild(btn);
              });
            })
            .catch((e) => {
              console.error("handoverTemplates èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼", e);
            });
        }

        if (clearBtn) {
          clearBtn.addEventListener('click', async () => {
            if (!confirm('ã“ã®æ™‚é–“å¸¯ã®å¼•ãç¶™ããƒ¡ãƒ¢ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) return;

            const businessKey = getCurrentBusinessKey();

            const snap = await handoverColRef
              .where('slotId', '==', slotId)
              .where('businessKey', '==', businessKey)
              .get();

            if (snap.empty) return;

            const batch = db.batch();
            snap.forEach((doc) => batch.delete(doc.ref));
            await batch.commit();
          });
        }
      });

      // --------------------------------
      // 4) çµŒå–¶è€…ãŠçŸ¥ã‚‰ã›ï¼ˆownerNewsï¼‰èª­ã¿è¾¼ã¿
      // --------------------------------
      const infoListEl = document.querySelector('.info-list');
      if (infoListEl) {
        const ownerNewsColRef = db.collection('ownerNews');

        ownerNewsColRef
          .orderBy('createdAt', 'desc')
          .limit(5)
          .onSnapshot(
            (snapshot) => {
              infoListEl.innerHTML = '';

              if (snapshot.empty) {
                const li = document.createElement('li');
                li.textContent = 'ç¾åœ¨ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
                infoListEl.appendChild(li);
                return;
              }

              snapshot.forEach((doc) => {
                const data = doc.data();
                const title = data.title || '';
                const body  = data.body  || '';

                const li = document.createElement('li');
                if (title && body) {
                  li.textContent = `ã€${title}ã€‘ ${body}`;
                } else if (title) {
                  li.textContent = `ã€${title}ã€‘`;
                } else {
                  li.textContent = body || '';
                }
                infoListEl.appendChild(li);
              });
            },
            (error) => {
              console.error('ownerNews èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', error);
              infoListEl.innerHTML = '';
              const li = document.createElement('li');
              li.textContent = 'ãŠçŸ¥ã‚‰ã›ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
              infoListEl.appendChild(li);
            }
          );
      }

      // ğŸ”¥ ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸï¼å‡ºå‹¤ãƒ­ã‚°ï¼ˆä»Šæ—¥ï¼‹ã“ã®æ™‚é–“å¸¯ï¼‹ã“ã®ç«¯æœ«ï¼‰ã‚’1å›ã ã‘è¨˜éŒ²
      recordAttendanceOncePerSlot();
    });
  </script>

</body>
</html>
