<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>å—éƒ¨ç”ºãƒ­ãƒ¼ã‚½ãƒ³ ç®¡ç†ç”»é¢ï¼ˆã‚ªãƒ¼ãƒŠãƒ¼ç”¨ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f5f5;
      color: #111;
      line-height: 1.6;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    /* ===== å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼ˆã‚¿ã‚¤ãƒŸãƒ¼é¢¨ï¼‰ ===== */
    .sidebar {
      width: 230px;
      background: #f7f7f8;
      border-right: 1px solid #ddd;
      padding: 12px 10px 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: sticky;
      top: 0;
      align-self: flex-start;
    }

    .sidebar-header {
      padding: 4px 8px 6px;
    }
    .sidebar-store {
      font-size: 13px;
      font-weight: 600;
    }
    .sidebar-role {
      font-size: 11px;
      color: #777;
      margin-top: 2px;
    }

    .sidebar-nav {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .sidebar-nav button {
      text-align: left;
      border-radius: 6px;
      border: none;
      padding: 7px 10px;
      font-size: 13px;
      background: transparent;
      cursor: pointer;
      color: #333;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-nav button span.label {
      flex: 1;
    }
    .sidebar-nav button span.badge {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: #eee;
      color: #666;
      margin-left: 4px;
    }

    .sidebar-nav button:hover {
      background: #e9eefc;
    }

    .sidebar-nav button.active {
      background: #1a73e8;
      color: #fff;
    }
    .sidebar-nav button.active span.badge {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }

    .sidebar-footer {
      margin-top: auto;
      font-size: 10px;
      color: #999;
      padding: 0 8px;
    }

    /* ===== å³ãƒ¡ã‚¤ãƒ³ã‚¨ãƒªã‚¢ ===== */
    .main {
      flex: 1;
      padding: 16px 20px 24px;
    }

    .main-header {
      margin-bottom: 12px;
    }
    .main-header-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 2px;
    }
    .main-header-sub {
      font-size: 12px;
      color: #666;
    }

    .view-panel {
      display: none;
    }
    .view-panel.active {
      display: block;
    }

    .card {
      background: #fff;
      border-radius: 12px;
      padding: 14px 16px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
    }

    .card h2 {
      font-size: 15px;
      margin-bottom: 2px;
    }
    .card-sub {
      font-size: 11px;
      color: #777;
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    input[type="text"],
    textarea,
    select {
      width: 100%;
      font-family: inherit;
      font-size: 13px;
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
      line-height: 1.5;
    }
    input[type="text"]:focus,
    textarea:focus,
    select:focus {
      border-color: #111;
    }

    select {
      padding: 4px 8px;
      font-size: 13px;
      background: #fff;
    }

    /* A/Bã‚¿ã‚¹ã‚¯ã®textareaã¯ç¸¦é•·ã«ã™ã‚‹ */
    #tasksAInput,
    #tasksBInput {
      min-height: 220px; /* â†ã“ã“ã§ç¸¦ã‚’é•·ãã—ãŸ */
    }

    .row {
      margin-bottom: 10px;
    }

    .hint {
      font-size: 11px;
      color: #777;
      margin-top: 2px;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      margin-bottom: 4px;
    }

    button {
      font-family: inherit;
      font-size: 13px;
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      cursor: pointer;
    }
    .btn-primary {
      background: #111;
      color: #fff;
    }
    .btn-secondary {
      background: #eee;
      color: #333;
    }
    .btn-danger {
      background: #f44;
      color: #fff;
    }

    .status {
      font-size: 12px;
      min-height: 18px;
      margin-top: 2px;
    }
    .status.ok {
      color: #007700;
    }
    .status.err {
      color: #cc0000;
    }

    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 10px 0;
    }

    /* ownerNews list */
    .news-list {
      list-style: none;
      font-size: 12px;
      max-height: 280px;
      overflow-y: auto;
      padding-right: 4px;
    }
    .news-item {
      border-bottom: 1px solid #eee;
      padding: 6px 0;
      display: flex;
      gap: 8px;
    }
    .news-main {
      flex: 1;
    }
    .news-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .news-body {
      font-size: 12px;
    }
    .news-meta {
      font-size: 10px;
      color: #888;
      margin-top: 2px;
    }
    .news-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }

    .slot-note {
      font-size: 11px;
      color: #666;
      margin-top: -2px;
      margin-bottom: 6px;
    }

    /* å¼•ãç¶™ããƒ¡ãƒ¢ ãƒ†ãƒ³ãƒ—ãƒ¬ preview */
    .handover-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      padding: 6px 4px;
      background: #fafafa;
      border-radius: 8px;
      border: 1px dashed #ddd;
    }
    .handover-preview-chip {
      font-size: 11px;
      padding: 3px 10px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #ddd;
      white-space: nowrap;
    }

    @media (max-width: 900px) {
      .layout {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        position: static;
      }
      .sidebar-header {
        flex: 1;
      }
      .sidebar-nav {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: flex-end;
      }
      .sidebar-footer {
        display: none;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <!-- ================= å·¦ãƒ¡ãƒ‹ãƒ¥ãƒ¼ ================= -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-store">å—éƒ¨ç”ºãƒ­ãƒ¼ã‚½ãƒ³</div>
        <div class="sidebar-role">ã‚ªãƒ¼ãƒŠãƒ¼ç®¡ç†ç”»é¢</div>
      </div>

      <nav class="sidebar-nav">
        <button type="button" data-view="news" class="active">
          <span class="label">ãŠçŸ¥ã‚‰ã›ç®¡ç†</span>
          <span class="badge">ownerNews</span>
        </button>
        <button type="button" data-view="tasks">
          <span class="label">æ™‚é–“å¸¯ã”ã¨ã®ã‚¿ã‚¹ã‚¯ç·¨é›†</span>
          <span class="badge">taskSlots</span>
        </button>
        <button type="button" data-view="handover">
          <span class="label">å¼•ãç¶™ããƒ¡ãƒ¢ï¼ˆãƒœã‚¿ãƒ³ç·¨é›†ï¼‰</span>
          <span class="badge">handoverTemplates</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        ã“ã®ç”»é¢ã§è¨­å®šã—ãŸå†…å®¹ãŒã€ã‚¹ã‚¿ãƒƒãƒ•ç”¨ãƒã‚§ãƒƒã‚¯ç”»é¢ã«åæ˜ ã•ã‚Œã¾ã™ã€‚
      </div>
    </aside>

    <!-- ================= å³ãƒ¡ã‚¤ãƒ³ ================= -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-title">ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <div class="main-header-sub">
          å·¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ç·¨é›†ã—ãŸã„é …ç›®ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚
        </div>
      </header>

      <!-- â‘  ãŠçŸ¥ã‚‰ã›ç®¡ç† -->
      <section id="view-news" class="view-panel active">
        <section class="card" id="news-card">
          <h2>ãŠçŸ¥ã‚‰ã›ç®¡ç†ï¼ˆownerNewsï¼‰</h2>
          <p class="card-sub">
            ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢ã®ã€ŒãŠçŸ¥ã‚‰ã›ã€æ¬„ã«è¡¨ç¤ºã•ã‚Œã‚‹å†…å®¹ã‚’ç™»éŒ²ãƒ»å‰Šé™¤ã§ãã¾ã™ã€‚
          </p>

          <div class="row">
            <label for="newsTitle">ã‚¿ã‚¤ãƒˆãƒ«</label>
            <input type="text" id="newsTitle" placeholder="ä¾‹ï¼‰FFæ²¹äº¤æ›ã«ã¤ã„ã¦" />
          </div>
          <div class="row">
            <label for="newsBody">æœ¬æ–‡</label>
            <textarea id="newsBody" placeholder="ä¾‹ï¼‰ä»Šé€±ã¯æ²¹äº¤æ›ã®é »åº¦ã‚’1æ—¥2å›ã«å¢—ã‚„ã—ã¦ãã ã•ã„ã€‚å¤œå‹¤å¸¯ã§å¯¾å¿œãŠé¡˜ã„ã—ã¾ã™ã€‚"></textarea>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-primary" id="newsAddBtn">ãŠçŸ¥ã‚‰ã›ã‚’è¿½åŠ </button>
            <button type="button" class="btn-secondary" id="newsClearFormBtn">å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢</button>
          </div>
          <div class="status" id="newsStatus"></div>

          <hr>

          <p class="hint">â€»æœ€æ–°20ä»¶ã¾ã§è¡¨ç¤ºã€‚å¤ã„ã‚‚ã®ã‹ã‚‰é †ã«å‰Šé™¤ã—ã¦OKã§ã™ã€‚</p>
          <ul class="news-list" id="newsList"></ul>
        </section>
      </section>

      <!-- â‘¡ ã‚¿ã‚¹ã‚¯å®šç¾©ç·¨é›† -->
      <section id="view-tasks" class="view-panel">
        <section class="card" id="tasks-card">
          <h2>æ™‚é–“å¸¯ã”ã¨ã®ã‚¿ã‚¹ã‚¯ç·¨é›†ï¼ˆtaskSlotsï¼‰</h2>
          <p class="card-sub">
            å„æ™‚é–“å¸¯ã® Aã‚¿ã‚¹ã‚¯ï¼ˆå¿…é ˆï¼‰ãƒ»Bã‚¿ã‚¹ã‚¯ï¼ˆä½™è£•ï¼‰ã‚’ç·¨é›†ã§ãã¾ã™ã€‚<br>
            ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢ã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã¯ã“ã“ã§å®šç¾©ã•ã‚ŒãŸå†…å®¹ã‹ã‚‰è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
          </p>

          <div class="row">
            <label for="slotSelect">ç·¨é›†ã™ã‚‹æ™‚é–“å¸¯</label>
            <select id="slotSelect">
              <option value="t6-8">6:00ã€œ8:00ï¼ˆæœã®ç«‹ã¡ä¸Šã’ï¼‰</option>
              <option value="t9-11">9:00ã€œ11:00ï¼ˆåˆå‰å¸¯ï¼‰</option>
              <option value="t12-14">12:00ã€œ14:00ï¼ˆæ˜¼å¸¯ï¼‰</option>
              <option value="t15-17">15:00ã€œ17:00ï¼ˆå¤•æ–¹å‰ï¼‰</option>
              <option value="t18-20">18:00ã€œ20:00ï¼ˆå¤•æ–¹ã€œå¤œï¼‰</option>
              <option value="t21-23">21:00ã€œ23:00ï¼ˆå¤œå¸¯ï¼‰</option>
              <option value="t0-2">0:00ã€œ2:00ï¼ˆæ·±å¤œå‰åŠï¼‰</option>
              <option value="t3-5">3:00ã€œ5:00ï¼ˆæ—©æœï¼‰</option>
            </select>
            <p class="slot-note">æ™‚é–“å¸¯ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ãã®æ™‚é–“å¸¯ã®ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ Firestore ã‹ã‚‰èª­ã¿è¾¼ã¿ã¾ã™ã€‚</p>
          </div>

          <div class="row">
            <label for="tasksAInput">Aã‚¿ã‚¹ã‚¯ï¼ˆå¿…é ˆï¼‰</label>
            <textarea id="tasksAInput" placeholder="ä¾‹ï¼‰&#10;CDCç´å“ãƒ»ç‰‡ã¥ã‘ï¼ˆ2ä¾¿ï¼‰&#10;ãƒ™ãƒ¼ã‚«ãƒªãƒ¼ç´å“ãƒ»ç‰‡ã¥ã‘ï¼ˆ2ä¾¿ï¼‰"></textarea>
            <div class="hint">1è¡Œã«ã¤ã1ã‚¿ã‚¹ã‚¯ã€‚ç©ºè¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚</div>
          </div>

          <div class="row">
            <label for="tasksBInput">Bã‚¿ã‚¹ã‚¯ï¼ˆä½™è£•ã‚ã‚Œã°ï¼‰</label>
            <textarea id="tasksBInput" placeholder="ä¾‹ï¼‰&#10;åº—å†…ãƒ»åº—é ­ã‚´ãƒŸç®±ã®æ¸…æƒ&#10;ã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ¼ãƒŠãƒ¼æ¸…æƒ"></textarea>
            <div class="hint">1è¡Œã«ã¤ã1ã‚¿ã‚¹ã‚¯ã€‚ç©ºè¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚</div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" id="reloadSlotBtn">é¸æŠä¸­ã®æ™‚é–“å¸¯ã‚’å†èª­ã¿è¾¼ã¿</button>
            <button type="button" class="btn-primary" id="saveSlotBtn">ã“ã®å†…å®¹ã§ä¿å­˜</button>
          </div>
          <div class="status" id="taskStatus"></div>

          <hr>

          <p class="hint">
            â€»ä¿å­˜ã™ã‚‹ã¨ã€ãã®æ™‚é–“å¸¯ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ï¼ˆå®Œäº†ãƒã‚§ãƒƒã‚¯ï¼‰ã ã‘ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™ï¼ˆä»–ã®æ™‚é–“å¸¯ã¯ãã®ã¾ã¾ï¼‰ã€‚<br>
            â€»ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆæœ¬ä½“ã® HTMLï¼ˆã‚¹ã‚¿ãƒƒãƒ•ç”¨ç”»é¢ï¼‰ã¯æ›¸ãæ›ãˆä¸è¦ã§ã™ã€‚ã“ã®ç”»é¢ã¯å®šç¾©ã ã‘ã‚’ã„ã˜ã‚‹å½¹å‰²ã€‚
          </p>
        </section>
      </section>

      <!-- â‘¢ å¼•ãç¶™ããƒ¡ãƒ¢ç”¨ãƒœã‚¿ãƒ³ç·¨é›† -->
      <section id="view-handover" class="view-panel">
        <section class="card" id="handover-card">
          <h2>å¼•ãç¶™ããƒ¡ãƒ¢ï¼ˆãƒœã‚¿ãƒ³æ–‡è¨€ã®ç·¨é›†ï¼‰</h2>
          <p class="card-sub">
            ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢ã®ã€Œå¼•ãç¶™ããƒ¡ãƒ¢ï¼ˆå…¨å“¡ã§å…±æœ‰ï¼‰ã€ã«ä¸¦ã‚“ã§ã„ã‚‹ãƒœã‚¿ãƒ³ã®æ–‡è¨€ã‚’ç·¨é›†ã§ãã¾ã™ã€‚<br>
            ä»Šã¯å…¨æ™‚é–“å¸¯ã§å…±é€šã®ãƒœã‚¿ãƒ³ã‚»ãƒƒãƒˆï¼ˆglobalï¼‰ã‚’ä½¿ã„ã¾ã™ã€‚
          </p>

          <div class="row">
            <label for="handoverChipsInput">ãƒœã‚¿ãƒ³æ–‡è¨€ãƒªã‚¹ãƒˆ</label>
            <textarea id="handoverChipsInput"
              placeholder="ä¾‹ï¼‰&#10;FFã‚±ãƒ¼ã‚¹æ¸…æƒæ¸ˆã¿&#10;ãƒ›ãƒƒãƒˆãƒ»å¸¸æ¸©FF è£œå……æ¸ˆã¿&#10;ç±³é£¯ãƒ»ãŠã«ãã‚Š å‰é™³ï¼†æ•´ç†æ¸ˆã¿"></textarea>
            <div class="hint">
              1è¡Œã«ã¤ã1ãƒœã‚¿ãƒ³ã«ãªã‚Šã¾ã™ã€‚ç©ºè¡Œã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚<br>
              ä¿å­˜ã™ã‚‹ã¨ã€å…¨ã¦ã®æ™‚é–“å¸¯ã®ã€Œå¼•ãç¶™ããƒ¡ãƒ¢ãƒœã‚¿ãƒ³ã€ãŒã“ã®å†…å®¹ã§ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
            </div>
          </div>

          <div class="btn-row">
            <button type="button" class="btn-secondary" id="handoverReloadBtn">ç¾åœ¨ã®è¨­å®šã‚’èª­ã¿è¾¼ã¿</button>
            <button type="button" class="btn-primary" id="handoverSaveBtn">ã“ã®å†…å®¹ã§ä¿å­˜</button>
          </div>
          <div class="status" id="handoverStatus"></div>

          <hr>

          <label>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</label>
          <div class="handover-preview" id="handoverPreview">
            <!-- JSã§ãƒœã‚¿ãƒ³ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¡¨ç¤º -->
          </div>

          <p class="hint" style="margin-top:6px;">
            â€»ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢å´ã§ã¯ <code>handoverTemplates/global</code> ã®å†…å®¹ã‚’èª­ã¿ã«ã„ãã¾ã™ã€‚<br>
            â€»ã‚¹ã‚¿ãƒƒãƒ•ç”»é¢ã®HTMLã§ã¯ã€ãƒœã‚¿ãƒ³éƒ¨åˆ†ã¯ç©ºã® <code>&lt;div class="handover-chips"&gt;&lt;/div&gt;</code> ã«ã—ã¦ãŠã„ã¦ãã ã•ã„ã€‚
          </p>
        </section>
      </section>
    </main>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script>
  // =============================
  // Firebase è¨­å®š
  // =============================
  const firebaseConfig = {
    apiKey: "AIzaSyAPBMvTpzKCcPxLETncBqVR8fzf0cqKirc",
    authDomain: "lawson-workflow.firebaseapp.com",
    projectId: "lawson-workflow",
    storageBucket: "lawson-workflow.firebasestorage.app",
    messagingSenderId: "335371795694",
    appId: "1:335371795694:web:3b0950a616d368b284c7ff",
    measurementId: "G-BGENZNZMRC"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // =============================
  // å–¶æ¥­æ—¥ã‚­ãƒ¼è¨ˆç®—ï¼ˆ6:00åˆ‡ã‚Šæ›¿ãˆï¼‰
  // =============================
  function getCurrentBusinessKey() {
    const now = new Date(); // åº—ã®PCãŒæ—¥æœ¬æ™‚é–“ãªã‚‰ãã®ã¾ã¾JST
    const y = now.getFullYear();
    const m = now.getMonth();
    const d = now.getDate();

    const base = new Date(y, m, d);

    // 0:00ã€œ5:59 ã¯ã€Œå‰æ—¥æ‰±ã„ã€
    if (now.getHours() < 6) {
      base.setDate(base.getDate() - 1);
    }

    const yy = base.getFullYear();
    const mm = String(base.getMonth() + 1).padStart(2, '0');
    const dd = String(base.getDate()).padStart(2, '0');
    return `${yy}-${mm}-${dd}`; // ä¾‹: "2025-11-22"
  }

  /****************************************************
   * ğŸ”¥ 6:00 è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆï¼ˆè¶…ã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼šãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿ï¼‰
   ****************************************************/
  function setupDailyResetAt6AM() {
    function scheduleNextReset() {
      const now = new Date();
      const next = new Date();

      // æ¬¡ã® 6:00 ã‚’è¨ˆç®—
      next.setHours(6, 0, 0, 0);
      if (now >= next) {
        next.setDate(next.getDate() + 1); // ä»Šæ—¥ã®6æ™‚ã‚’éãã¦ãŸã‚‰ç¿Œæ—¥
      }

      const ms = next - now;
      console.log('æ¬¡ã® 6:00 ãƒªã‚»ãƒƒãƒˆã¾ã§:', ms / 1000 / 60, 'åˆ†');

      setTimeout(() => {
        console.log('ğŸ”¥ 6:00åˆ°é” â†’ å–¶æ¥­æ—¥åˆ‡æ›¿ã®ãŸã‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿');
        on6amReset();
        scheduleNextReset(); // æ¬¡ã®æ—¥ã® 6:00 ã‚‚ã‚»ãƒƒãƒˆ
      }, ms);
    }

    scheduleNextReset();
  }

  function on6amReset() {
    location.reload();
  }

  // =============================
  // DOM æº–å‚™ã§ããŸã‚‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  // =============================
  document.addEventListener('DOMContentLoaded', () => {

    // ğŸ”¥ æœ6:00 è‡ªå‹•ãƒªã‚»ãƒƒãƒˆé–‹å§‹
    setupDailyResetAt6AM();

    // =============================
    // ç¾åœ¨æ™‚åˆ»ãƒ»å–¶æ¥­æ—¥ãƒ»æ¬¡ãƒªã‚»ãƒƒãƒˆè¡¨ç¤º
    // =============================
    const timeDisplay = document.getElementById('time-display');

    function updateTimeDisplay() {
      if (!timeDisplay) return;

      const now = new Date();
      const jp = now.toLocaleString('ja-JP', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        weekday: 'short',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });

      const businessKey = getCurrentBusinessKey();

      // æ¬¡ã® 6:00 ã‚’è¨ˆç®—
      let nextReset = new Date();
      nextReset.setHours(6, 0, 0, 0);
      if (now >= nextReset) {
        nextReset.setDate(nextReset.getDate() + 1);
      }
      const nextResetStr = nextReset.toLocaleString('ja-JP', {
        month: '2-digit',
        day: '2-digit',
        weekday: 'short',
        hour: '2-digit',
        minute: '2-digit'
      });

      timeDisplay.innerHTML = `
        <div><strong>ç¾åœ¨æ™‚åˆ»ï¼š</strong> ${jp}</div>
        <div><strong>ä»Šæ—¥ã®å–¶æ¥­æ—¥ï¼š</strong> ${businessKey}ï¼ˆ6:00åˆ‡æ›¿ï¼‰</div>
        <div><strong>æ¬¡ã®ãƒªã‚»ãƒƒãƒˆï¼š</strong> ${nextResetStr}</div>
      `;
    }

    updateTimeDisplay();
    setInterval(updateTimeDisplay, 1000);

    // --------------------------------
    // 1) ã‚¿ã‚¹ã‚¯å®šç¾©ï¼ˆtaskSlotsï¼‰ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
    // --------------------------------
    const timeSlotIds = ['t6-8', 't9-11', 't12-14', 't15-17', 't18-20', 't21-23', 't0-2', 't3-5'];
    const checkboxMap = new Map();        // taskId -> checkbox
    let latestCheckedIds = new Set();     // Firestore ã‹ã‚‰æ¥ãŸãƒã‚§ãƒƒã‚¯æ¸ˆã¿ID
    const taskDocRef = db.collection('tasks').doc('lawson-main');
    let applyingRemote = false;

    // taskId ã®ä»˜ã‘æ–¹ï¼š
    //   ä¾‹ï¼‰"t6-8-A-0" ï¼ 6ã€œ8æ™‚ã® A ã‚°ãƒ«ãƒ¼ãƒ— 0ç•ªç›®
    function buildTasksFromDefinition(slotId, ul, tasks, groupLabel) {
      ul.innerHTML = '';
      tasks.forEach((text, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
          <label class="task-item">
            <input type="checkbox">
            <span class="task-text"></span>
          </label>
        `;
        const cb   = li.querySelector('input[type="checkbox"]');
        const span = li.querySelector('.task-text');
        span.textContent = text;

        const taskId = `${slotId}-${groupLabel}-${index}`;
        cb.dataset.taskId = taskId;
        checkboxMap.set(taskId, cb);

        // æ—¢ã« Firestore ã‹ã‚‰çŠ¶æ…‹ãŒæ¥ã¦ã„ãŸã‚‰åæ˜ 
        cb.checked = latestCheckedIds.has(taskId);

        ul.appendChild(li);
      });
    }

    async function loadTaskDefinitions() {
      const taskSlotsRef = db.collection('taskSlots');

      await Promise.all(
        timeSlotIds.map(async (slotId) => {
          const section = document.getElementById(slotId);
          if (!section) return;

          const ulA = section.querySelector('ul.tasks.a');
          const ulB = section.querySelector('ul.tasks.b');
          if (!ulA || !ulB) return;

          try {
            const snap = await taskSlotsRef.doc(slotId).get();
            if (snap.exists) {
              const data = snap.data() || {};
              const tasksA = data.tasksA || [];
              const tasksB = data.tasksB || [];

              buildTasksFromDefinition(slotId, ulA, tasksA, 'A');
              buildTasksFromDefinition(slotId, ulB, tasksB, 'B');
            } else {
              // Firestore ã«å®šç¾©ãŒç„¡ã„ã¨ãï¼š
              // ã„ã¾ HTML ã«æ›¸ã‹ã‚Œã¦ã„ã‚‹ li ã‹ã‚‰ taskId ã‚’æŒ¯ã‚‹
              const setupFromExisting = (ul, groupLabel) => {
                const lis = ul.querySelectorAll('li');
                lis.forEach((li, index) => {
                  const cb = li.querySelector('input[type="checkbox"]');
                  if (!cb) return;
                  const taskId = `${slotId}-${groupLabel}-${index}`;
                  cb.dataset.taskId = taskId;
                  checkboxMap.set(taskId, cb);
                  cb.checked = latestCheckedIds.has(taskId);
                });
              };
              setupFromExisting(ulA, 'A');
              setupFromExisting(ulB, 'B');
            }
          } catch (e) {
            console.error('ã‚¿ã‚¹ã‚¯å®šç¾©èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', slotId, e);
          }
        })
      );
    }

    // --------------------------------
    // 2) ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ â†” Firestore åŒæœŸ
    // --------------------------------
    function saveTasksToFirestore() {
      const checkedIds = [];
      checkboxMap.forEach((cb, id) => {
        if (cb.checked) checkedIds.push(id);
      });
      const businessKey = getCurrentBusinessKey();
      taskDocRef.set(
        { checkedIds, businessKey },
        { merge: true }
      );
    }

    taskDocRef.onSnapshot((doc) => {
      const data = doc.exists ? doc.data() : {};
      const storedKey  = data.businessKey;
      const currentKey = getCurrentBusinessKey();

      if (storedKey !== currentKey) {
        // æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã„ãŸã‚‰ãƒªã‚»ãƒƒãƒˆ
        taskDocRef.set(
          { checkedIds: [], businessKey: currentKey },
          { merge: true }
        );
        latestCheckedIds = new Set();
      } else {
        latestCheckedIds = new Set(data.checkedIds || []);
      }

      applyingRemote = true;
      checkboxMap.forEach((cb, id) => {
        cb.checked = latestCheckedIds.has(id);
      });
      applyingRemote = false;
    });

    document.body.addEventListener('change', (e) => {
      const target = e.target;
      if (!target.matches('input[type="checkbox"][data-task-id]')) return;
      if (applyingRemote) return;
      saveTasksToFirestore();
    });

    // å…ˆã«ã‚¿ã‚¹ã‚¯å®šç¾©ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã¯ onSnapshot ã§å¾Œã‹ã‚‰è¿½å¾“ï¼‰
    loadTaskDefinitions();

    // --------------------------------
    // 3) å¼•ãç¶™ããƒ¡ãƒ¢ï¼ˆæ™‚é–“å¸¯ã”ã¨ï¼‹ãƒœã‚¿ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ï¼‰
    // --------------------------------
    const handoverSlots  = document.querySelectorAll('.handover-slot');
    const handoverColRef = db.collection('handover');
    const handoverTplRef = db.collection('handoverTemplates').doc('global');

    // slotId â†’ ãã®æ™‚é–“å¸¯ã®ã€Œãƒ¡ãƒ¢è¿½åŠ é–¢æ•°ã€ã‚’è¦šãˆã¦ãŠã
    const handoverAdders = new Map();

    // ãƒ¡ãƒ¢ä¸€è¦§ã®æç”»
    function renderHandoverList(snapshot, logEl) {
      if (!logEl) return;

      logEl.innerHTML = '';

      if (snapshot.empty) {
        const li = document.createElement('li');
        li.textContent = 'ã¾ã å¼•ãç¶™ããƒ¡ãƒ¢ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
        li.style.fontSize = '10px';
        li.style.color = '#999';
        logEl.appendChild(li);
        return;
      }

      const docs = [];
      snapshot.forEach((doc) => docs.push(doc));

      // createdAt é™é †ï¼ˆæ–°ã—ã„é †ï¼‰
      docs.sort((a, b) => {
        const da = a.data().createdAt ? a.data().createdAt.toMillis() : 0;
        const db = b.data().createdAt ? b.data().createdAt.toMillis() : 0;
        return db - da;
      });

      docs.forEach((doc) => {
        const data = doc.data();
        const li = document.createElement('li');
        li.className = 'handover-item';

        const textSpan = document.createElement('span');
        textSpan.className = 'handover-text';
        textSpan.textContent = data.text || '';

        const timeSpan = document.createElement('span');
        timeSpan.className = 'handover-time';
        timeSpan.textContent = data.timeLabel || '';

        const delBtn = document.createElement('button');
        delBtn.className = 'handover-remove';
        delBtn.textContent = 'âœ•';
        delBtn.addEventListener('click', () => {
          doc.ref.delete();
        });

        li.appendChild(textSpan);
        li.appendChild(timeSpan);
        li.appendChild(delBtn);

        logEl.appendChild(li);
      });
    }

    // å„æ™‚é–“å¸¯ã‚¹ãƒ­ãƒƒãƒˆã”ã¨ã®è¨­å®š
    handoverSlots.forEach((slotEl) => {
      const slotId   = slotEl.dataset.slot || 'global';
      const logEl    = slotEl.querySelector('.handover-log');
      const clearBtn = slotEl.querySelector('.handover-clear-btn');

      // ã“ã®æ™‚é–“å¸¯å°‚ç”¨ã® listenerï¼ˆä»Šæ—¥ã®å–¶æ¥­æ—¥ï¼‹slotId ã§çµã‚‹ï¼‰
      handoverColRef
        .where('businessKey', '==', getCurrentBusinessKey())
        .where('slotId', '==', slotId)
        .onSnapshot((snapshot) => {
          renderHandoverList(snapshot, logEl);
        });

      // ã“ã®æ™‚é–“å¸¯ã«ãƒ¡ãƒ¢ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°ï¼ˆãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã¶ï¼‰
      function addHandoverForSlot(text) {
        const now = new Date();
        const timeLabel = now.toLocaleTimeString('ja-JP', {
          hour: '2-digit',
          minute: '2-digit'
        });
        const businessKey = getCurrentBusinessKey();

        handoverColRef.add({
          text,
          slotId,
          businessKey,
          timeLabel,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }

      handoverAdders.set(slotId, addHandoverForSlot);

      // ã€Œãƒ¡ãƒ¢ã‚’å…¨éƒ¨æ¶ˆã™ã€ãƒœã‚¿ãƒ³
      if (clearBtn) {
        clearBtn.addEventListener('click', async () => {
          if (!confirm('ã“ã®æ™‚é–“å¸¯ã®å¼•ãç¶™ããƒ¡ãƒ¢ã‚’å…¨éƒ¨æ¶ˆã—ã¾ã™ã‹ï¼Ÿ')) return;

          const businessKey = getCurrentBusinessKey();
          const snap = await handoverColRef
            .where('slotId', '==', slotId)
            .where('businessKey', '==', businessKey)
            .get();

          if (snap.empty) return;
          const batch = db.batch();
          snap.forEach((doc) => batch.delete(doc.ref));
          await batch.commit();
        });
      }
    });

    // â–¼ å¼•ãç¶™ããƒ¡ãƒ¢ç”¨ãƒœã‚¿ãƒ³ãƒ†ãƒ³ãƒ—ãƒ¬ï¼ˆglobalï¼‰ã‚’èª­ã¿è¾¼ã‚“ã§ã€
    //   å„æ™‚é–“å¸¯ã® .handover-chips ã«ãƒœã‚¿ãƒ³ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
    handoverTplRef.onSnapshot(
      (doc) => {
        const data  = doc.exists ? doc.data() : {};
        const chips = Array.isArray(data.chips) ? data.chips : [];

        handoverSlots.forEach((slotEl) => {
          const slotId  = slotEl.dataset.slot || 'global';
          const chipsEl = slotEl.querySelector('.handover-chips');
          const addFn   = handoverAdders.get(slotId);

          if (!chipsEl || !addFn) return;

          chipsEl.innerHTML = '';

          if (chips.length === 0) {
            const span = document.createElement('span');
            span.style.fontSize = '10px';
            span.style.color = '#999';
            span.textContent = 'ãƒœã‚¿ãƒ³æœªè¨­å®š';
            chipsEl.appendChild(span);
            return;
          }

          chips.forEach((text) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'handover-chip';
            btn.dataset.text = text;
            btn.textContent = text;
            btn.addEventListener('click', () => {
              addFn(text);
            });
            chipsEl.appendChild(btn);
          });
        });
      },
      (error) => {
        console.error('handoverTemplates èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', error);
      }
    );

    // --------------------------------
    // 4) çµŒå–¶è€…ãŠçŸ¥ã‚‰ã›ï¼ˆownerNewsï¼‰èª­ã¿è¾¼ã¿
    // --------------------------------
    const infoListEl = document.querySelector('.info-list');
    if (infoListEl) {
      const ownerNewsColRef = db.collection('ownerNews');

      ownerNewsColRef
        .orderBy('createdAt', 'desc')
        .limit(5)
        .onSnapshot(
          (snapshot) => {
            infoListEl.innerHTML = '';

            if (snapshot.empty) {
              const li = document.createElement('li');
              li.textContent = 'ç¾åœ¨ã€ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚';
              infoListEl.appendChild(li);
              return;
            }

            snapshot.forEach((doc) => {
              const data = doc.data();
              const title = data.title || '';
              const body  = data.body  || '';

              const li = document.createElement('li');
              if (title && body) {
                li.textContent = `ã€${title}ã€‘ ${body}`;
              } else if (title) {
                li.textContent = `ã€${title}ã€‘`;
              } else {
                li.textContent = body || '';
              }
              infoListEl.appendChild(li);
            });
          },
          (error) => {
            console.error('ownerNews èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼', error);
            infoListEl.innerHTML = '';
            const li = document.createElement('li');
            li.textContent = 'ãŠçŸ¥ã‚‰ã›ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚';
            infoListEl.appendChild(li);
          }
        );
    }
  });
</script>

</body>
</html>
